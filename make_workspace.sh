# Fit signal peak
FitSignal Input=shapes/mmtt15_et_SR.txt Output=intermediary/signal_parameters_mmtt15_et.txt Plot=plots/signalFit_15_et
FitSignal Input=shapes/mmtt15_ee_SR.txt Output=intermediary/signal_parameters_mmtt15_ee.txt Plot=plots/signalFit_15_ee
FitSignal Input=shapes/mmtt15_em_SR.txt Output=intermediary/signal_parameters_mmtt15_em.txt Plot=plots/signalFit_15_em
FitSignal Input=shapes/mmtt15_mt_SR.txt Output=intermediary/signal_parameters_mmtt15_mt.txt Plot=plots/signalFit_15_mt
FitSignal Input=shapes/mmtt15_tt_SR.txt Output=intermediary/signal_parameters_mmtt15_tt.txt Plot=plots/signalFit_15_tt
FitSignal Input=shapes/mmtt15_mm_SR.txt Output=intermediary/signal_parameters_mmtt15_mm.txt Plot=plots/signalFit_15_mm

FitSignal Input=shapes/mmtt20_et_SR.txt Output=intermediary/signal_parameters_mmtt20_et.txt Plot=plots/signalFit_20_et
FitSignal Input=shapes/mmtt20_ee_SR.txt Output=intermediary/signal_parameters_mmtt20_ee.txt Plot=plots/signalFit_20_ee
FitSignal Input=shapes/mmtt20_em_SR.txt Output=intermediary/signal_parameters_mmtt20_em.txt Plot=plots/signalFit_20_em
FitSignal Input=shapes/mmtt20_mt_SR.txt Output=intermediary/signal_parameters_mmtt20_mt.txt Plot=plots/signalFit_20_mt
FitSignal Input=shapes/mmtt20_tt_SR.txt Output=intermediary/signal_parameters_mmtt20_tt.txt Plot=plots/signalFit_20_tt
FitSignal Input=shapes/mmtt20_mm_SR.txt Output=intermediary/signal_parameters_mmtt20_mm.txt Plot=plots/signalFit_20_mm

FitSignal Input=shapes/mmtt25_et_SR.txt Output=intermediary/signal_parameters_mmtt25_et.txt Plot=plots/signalFit_25_et
FitSignal Input=shapes/mmtt25_ee_SR.txt Output=intermediary/signal_parameters_mmtt25_ee.txt Plot=plots/signalFit_25_ee
FitSignal Input=shapes/mmtt25_em_SR.txt Output=intermediary/signal_parameters_mmtt25_em.txt Plot=plots/signalFit_25_em
FitSignal Input=shapes/mmtt25_mt_SR.txt Output=intermediary/signal_parameters_mmtt25_mt.txt Plot=plots/signalFit_25_mt
FitSignal Input=shapes/mmtt25_tt_SR.txt Output=intermediary/signal_parameters_mmtt25_tt.txt Plot=plots/signalFit_25_tt
FitSignal Input=shapes/mmtt25_mm_SR.txt Output=intermediary/signal_parameters_mmtt25_mm.txt Plot=plots/signalFit_25_mm

FitSignal Input=shapes/mmtt30_et_SR.txt Output=intermediary/signal_parameters_mmtt30_et.txt Plot=plots/signalFit_30_et
FitSignal Input=shapes/mmtt30_ee_SR.txt Output=intermediary/signal_parameters_mmtt30_ee.txt Plot=plots/signalFit_30_ee
FitSignal Input=shapes/mmtt30_em_SR.txt Output=intermediary/signal_parameters_mmtt30_em.txt Plot=plots/signalFit_30_em
FitSignal Input=shapes/mmtt30_mt_SR.txt Output=intermediary/signal_parameters_mmtt30_mt.txt Plot=plots/signalFit_30_mt
FitSignal Input=shapes/mmtt30_tt_SR.txt Output=intermediary/signal_parameters_mmtt30_tt.txt Plot=plots/signalFit_30_tt
FitSignal Input=shapes/mmtt30_mm_SR.txt Output=intermediary/signal_parameters_mmtt30_mm.txt Plot=plots/signalFit_30_mm

FitSignal Input=shapes/mmtt35_et_SR.txt Output=intermediary/signal_parameters_mmtt35_et.txt Plot=plots/signalFit_35_et
FitSignal Input=shapes/mmtt35_ee_SR.txt Output=intermediary/signal_parameters_mmtt35_ee.txt Plot=plots/signalFit_35_ee
FitSignal Input=shapes/mmtt35_em_SR.txt Output=intermediary/signal_parameters_mmtt35_em.txt Plot=plots/signalFit_35_em
FitSignal Input=shapes/mmtt35_mt_SR.txt Output=intermediary/signal_parameters_mmtt35_mt.txt Plot=plots/signalFit_35_mt
FitSignal Input=shapes/mmtt35_tt_SR.txt Output=intermediary/signal_parameters_mmtt35_tt.txt Plot=plots/signalFit_35_tt
FitSignal Input=shapes/mmtt35_mm_SR.txt Output=intermediary/signal_parameters_mmtt35_mm.txt Plot=plots/signalFit_35_mm

FitSignal Input=shapes/mmtt40_et_SR.txt Output=intermediary/signal_parameters_mmtt40_et.txt Plot=plots/signalFit_40_et
FitSignal Input=shapes/mmtt40_ee_SR.txt Output=intermediary/signal_parameters_mmtt40_ee.txt Plot=plots/signalFit_40_ee
FitSignal Input=shapes/mmtt40_em_SR.txt Output=intermediary/signal_parameters_mmtt40_em.txt Plot=plots/signalFit_40_em
FitSignal Input=shapes/mmtt40_mt_SR.txt Output=intermediary/signal_parameters_mmtt40_mt.txt Plot=plots/signalFit_40_mt
FitSignal Input=shapes/mmtt40_tt_SR.txt Output=intermediary/signal_parameters_mmtt40_tt.txt Plot=plots/signalFit_40_tt
FitSignal Input=shapes/mmtt40_mm_SR.txt Output=intermediary/signal_parameters_mmtt40_mm.txt Plot=plots/signalFit_40_mm

FitSignal Input=shapes/mmtt45_et_SR.txt Output=intermediary/signal_parameters_mmtt45_et.txt Plot=plots/signalFit_45_et
FitSignal Input=shapes/mmtt45_ee_SR.txt Output=intermediary/signal_parameters_mmtt45_ee.txt Plot=plots/signalFit_45_ee
FitSignal Input=shapes/mmtt45_em_SR.txt Output=intermediary/signal_parameters_mmtt45_em.txt Plot=plots/signalFit_45_em
FitSignal Input=shapes/mmtt45_mt_SR.txt Output=intermediary/signal_parameters_mmtt45_mt.txt Plot=plots/signalFit_45_mt
FitSignal Input=shapes/mmtt45_tt_SR.txt Output=intermediary/signal_parameters_mmtt45_tt.txt Plot=plots/signalFit_45_tt
FitSignal Input=shapes/mmtt45_mm_SR.txt Output=intermediary/signal_parameters_mmtt45_mm.txt Plot=plots/signalFit_45_mm

FitSignal Input=shapes/mmtt50_et_SR.txt Output=intermediary/signal_parameters_mmtt50_et.txt Plot=plots/signalFit_50_et
FitSignal Input=shapes/mmtt50_ee_SR.txt Output=intermediary/signal_parameters_mmtt50_ee.txt Plot=plots/signalFit_50_ee
FitSignal Input=shapes/mmtt50_em_SR.txt Output=intermediary/signal_parameters_mmtt50_em.txt Plot=plots/signalFit_50_em
FitSignal Input=shapes/mmtt50_mt_SR.txt Output=intermediary/signal_parameters_mmtt50_mt.txt Plot=plots/signalFit_50_mt
FitSignal Input=shapes/mmtt50_tt_SR.txt Output=intermediary/signal_parameters_mmtt50_tt.txt Plot=plots/signalFit_50_tt
FitSignal Input=shapes/mmtt50_mm_SR.txt Output=intermediary/signal_parameters_mmtt50_mm.txt Plot=plots/signalFit_50_mm

FitSignal Input=shapes/mmtt55_et_SR.txt Output=intermediary/signal_parameters_mmtt55_et.txt Plot=plots/signalFit_55_et
FitSignal Input=shapes/mmtt55_ee_SR.txt Output=intermediary/signal_parameters_mmtt55_ee.txt Plot=plots/signalFit_55_ee
FitSignal Input=shapes/mmtt55_em_SR.txt Output=intermediary/signal_parameters_mmtt55_em.txt Plot=plots/signalFit_55_em
FitSignal Input=shapes/mmtt55_mt_SR.txt Output=intermediary/signal_parameters_mmtt55_mt.txt Plot=plots/signalFit_55_mt
FitSignal Input=shapes/mmtt55_tt_SR.txt Output=intermediary/signal_parameters_mmtt55_tt.txt Plot=plots/signalFit_55_tt
FitSignal Input=shapes/mmtt55_mm_SR.txt Output=intermediary/signal_parameters_mmtt55_mm.txt Plot=plots/signalFit_55_mm

FitSignal Input=shapes/mmtt60_et_SR.txt Output=intermediary/signal_parameters_mmtt60_et.txt Plot=plots/signalFit_60_et
FitSignal Input=shapes/mmtt60_ee_SR.txt Output=intermediary/signal_parameters_mmtt60_ee.txt Plot=plots/signalFit_60_ee
FitSignal Input=shapes/mmtt60_em_SR.txt Output=intermediary/signal_parameters_mmtt60_em.txt Plot=plots/signalFit_60_em
FitSignal Input=shapes/mmtt60_mt_SR.txt Output=intermediary/signal_parameters_mmtt60_mt.txt Plot=plots/signalFit_60_mt
FitSignal Input=shapes/mmtt60_tt_SR.txt Output=intermediary/signal_parameters_mmtt60_tt.txt Plot=plots/signalFit_60_tt
FitSignal Input=shapes/mmtt60_mm_SR.txt Output=intermediary/signal_parameters_mmtt60_mm.txt Plot=plots/signalFit_60_mm

#Extrapolate signal parameters (when several mass points)
root -b -q 'Measure_signal_parameters.cc(91)'
root -b -q 'Measure_signal_parameters.cc(92)'
root -b -q 'Measure_signal_parameters.cc(93)'
root -b -q 'Measure_signal_parameters.cc(94)'
root -b -q 'Measure_signal_parameters.cc(82)'
root -b -q 'Measure_signal_parameters.cc(83)'

#Create signal workspace
SignalWorkspace Input=intermediary/outfile_et.txt Output=datacards/mmtt_signal_et.root 
SignalWorkspace Input=intermediary/outfile_mt.txt Output=datacards/mmtt_signal_mt.root
SignalWorkspace Input=intermediary/outfile_em.txt Output=datacards/mmtt_signal_em.root
SignalWorkspace Input=intermediary/outfile_tt.txt Output=datacards/mmtt_signal_tt.root
SignalWorkspace Input=intermediary/outfile_ee.txt Output=datacards/mmtt_signal_ee.root
SignalWorkspace Input=intermediary/outfile_mm.txt Output=datacards/mmtt_signal_mm.root

#Fit ZZ shape
ZZFit Input=shapes/ZZ4L_tt_SR.txt Output=datacards/mmtt_ZZ_tt.root Plot=plots/ZZFit_tt Norm=norm/ZZ_tt.txt
ZZFit Input=shapes/ZZ4L_et_SR.txt Output=datacards/mmtt_ZZ_et.root Plot=plots/ZZFit_et Norm=norm/ZZ_et.txt
ZZFit Input=shapes/ZZ4L_mt_SR.txt Output=datacards/mmtt_ZZ_mt.root Plot=plots/ZZFit_mt Norm=norm/ZZ_mt.txt
ZZFit Input=shapes/ZZ4L_em_SR.txt Output=datacards/mmtt_ZZ_em.root Plot=plots/ZZFit_em Norm=norm/ZZ_em.txt
ZZFit Input=shapes/ZZ4L_ee_SR.txt Output=datacards/mmtt_ZZ_ee.root Plot=plots/ZZFit_ee Norm=norm/ZZ_ee.txt
ZZFit Input=shapes/ZZ4L_mm_SR.txt Output=datacards/mmtt_ZZ_mm.root Plot=plots/ZZFit_mm Norm=norm/ZZ_mm.txt

#Fit reducible background shape
FakeFit Input=shapes/data_obs_tt_CR.txt Output=datacards/mmtt_Fake_tt.root Plot=plots/ReducibleFit_tt Norm=norm/Reducible_tt.txt
FakeFit Input=shapes/data_obs_et_CR.txt Output=datacards/mmtt_Fake_et.root Plot=plots/ReducibleFit_et Norm=norm/Reducible_et.txt
FakeFit Input=shapes/data_obs_mt_CR.txt Output=datacards/mmtt_Fake_mt.root Plot=plots/ReducibleFit_mt Norm=norm/Reducible_mt.txt
FakeFit Input=shapes/data_obs_em_CR.txt Output=datacards/mmtt_Fake_em.root Plot=plots/ReducibleFit_em Norm=norm/Reducible_em.txt
FakeFit Input=shapes/data_obs_ee_CR.txt Output=datacards/mmtt_Fake_ee.root Plot=plots/ReducibleFit_ee Norm=norm/Reducible_ee.txt
FakeFit Input=shapes/data_obs_mm_CR.txt Output=datacards/mmtt_Fake_mm.root Plot=plots/ReducibleFit_mm Norm=norm/Reducible_mm.txt

#Create workspace
DataWorkspace Input=shapes/data_obs_et_SR.txt Output=datacards/mmtt_data_et.root
DataWorkspace Input=shapes/data_obs_mt_SR.txt Output=datacards/mmtt_data_mt.root
DataWorkspace Input=shapes/data_obs_em_SR.txt Output=datacards/mmtt_data_em.root
DataWorkspace Input=shapes/data_obs_tt_SR.txt Output=datacards/mmtt_data_tt.root
DataWorkspace Input=shapes/data_obs_ee_SR.txt Output=datacards/mmtt_data_ee.root
DataWorkspace Input=shapes/data_obs_mm_SR.txt Output=datacards/mmtt_data_mm.root

#Make prefit plots
Plot Signal=datacards/mmtt_signal_ee.root Fake=datacards/mmtt_Fake_ee.root ZZ=datacards/mmtt_ZZ_ee.root Plot=plots/ee.png ZZNorm=norm/ZZ_ee.txt FakeNorm=norm/Reducible_mmee.txt Data=shapes/data_obs_ee_SR.txt
Plot Signal=datacards/mmtt_signal_em.root Fake=datacards/mmtt_Fake_em.root ZZ=datacards/mmtt_ZZ_em.root Plot=plots/em.png ZZNorm=norm/ZZ_em.txt FakeNorm=norm/Reducible_mmme.txt Data=shapes/data_obs_em_SR.txt
Plot Signal=datacards/mmtt_signal_et.root Fake=datacards/mmtt_Fake_et.root ZZ=datacards/mmtt_ZZ_et.root Plot=plots/et.png ZZNorm=norm/ZZ_et.txt FakeNorm=norm/Reducible_mmet.txt Data=shapes/data_obs_et_SR.txt
Plot Signal=datacards/mmtt_signal_mt.root Fake=datacards/mmtt_Fake_mt.root ZZ=datacards/mmtt_ZZ_mt.root Plot=plots/mt.png ZZNorm=norm/ZZ_mt.txt FakeNorm=norm/Reducible_mmmt.txt Data=shapes/data_obs_mt_SR.txt
Plot Signal=datacards/mmtt_signal_tt.root Fake=datacards/mmtt_Fake_tt.root ZZ=datacards/mmtt_ZZ_tt.root Plot=plots/tt.png ZZNorm=norm/ZZ_tt.txt FakeNorm=norm/Reducible_mmtt.txt Data=shapes/data_obs_tt_SR.txt
Plot Signal=datacards/mmtt_signal_mm.root Fake=datacards/mmtt_Fake_mm.root ZZ=datacards/mmtt_ZZ_mm.root Plot=plots/mm.png ZZNorm=norm/ZZ_mm.txt FakeNorm=norm/Reducible_mm.txt Data=shapes/data_obs_mm_SR.txt

#Plot signal model for different masses
#PlotSignal Signal=datacards/mmtt_signal_tt.root Plot=plots/signaltt
#PlotSignal Signal=datacards/mmtt_signal_mt.root Plot=plots/signalmt
#PlotSignal Signal=datacards/mmtt_signal_ee.root Plot=plots/signalee
#PlotSignal Signal=datacards/mmtt_signal_et.root Plot=plots/signalet
#PlotSignal Signal=datacards/mmtt_signal_em.root Plot=plots/signalem

#Make a txt file with all observed events
cat shapes/data_obs_ee_SR.txt shapes/data_obs_em_SR.txt shapes/data_obs_et_SR.txt shapes/data_obs_mt_SR.txt shapes/data_obs_tt_SR.txt > shapes/data_obs_cmb.txt

#Make a combined plot of all final states
CombinedPlot Signal1=datacards/mmtt_signal_ee.root Fake1=datacards/mmtt_Fake_ee.root ZZ1=datacards/mmtt_ZZ_ee.root Plot=plots/cmb.png ZZNorm1=norm/ZZ_ee.txt FakeNorm1=norm/Reducible_ee.txt Signal2=datacards/mmtt_signal_em.root Fake2=datacards/mmtt_Fake_em.root ZZ2=datacards/mmtt_ZZ_em.root ZZNorm2=norm/ZZ_em.txt FakeNorm2=norm/Reducible_em.txt Signal3=datacards/mmtt_signal_et.root Fake3=datacards/mmtt_Fake_et.root ZZ3=datacards/mmtt_ZZ_et.root ZZNorm3=norm/ZZ_et.txt FakeNorm3=norm/Reducible_et.txt Signal4=datacards/mmtt_signal_mt.root Fake4=datacards/mmtt_Fake_mt.root ZZ4=datacards/mmtt_ZZ_mt.root ZZNorm4=norm/ZZ_mt.txt FakeNorm4=norm/Reducible_mt.txt Signal5=datacards/mmtt_signal_tt.root Fake5=datacards/mmtt_Fake_tt.root ZZ5=datacards/mmtt_ZZ_tt.root ZZNorm5=norm/ZZ_tt.txt FakeNorm5=norm/Reducible_tt.txt Data=shapes/data_obs_cmb.txt

#Maximum likelihood fit
#combine -M MaxLikelihoodFit datacard_cmb.txt -m 20 --freezeNuisances MH --saveWithUncertainties --saveNormalization --saveShapes --rMax 80

#Make postfit plots
#Plot_postfit Signal=datacards/mmtt_signal_ee.root Ch=ch1 Mlfit=mlfit.root Plot=plots/ee_postfit ZZNorm=norm_postfit/ZZ_mmee.txt FakeNorm=norm_postfit/Fake_mmee.txt Data=shapes/Data.root_ee_SR.txt
#Plot_postfit Signal=datacards/mmtt_signal_em.root Ch=ch2 Mlfit=mlfit.root Plot=plots/em_postfit ZZNorm=norm_postfit/ZZ_mmme.txt FakeNorm=norm_postfit/Fake_mmme.txt Data=shapes/Data.root_em_SR.txt
#Plot_postfit Signal=datacards/mmtt_signal_et.root Ch=ch3 Mlfit=mlfit.root Plot=plots/et_postfit ZZNorm=norm_postfit/ZZ_mmet.txt FakeNorm=norm_postfit/Fake_mmet.txt Data=shapes/Data.root_et_SR.txt
#Plot_postfit Signal=datacards/mmtt_signal_mt.root Ch=ch4 Mlfit=mlfit.root Plot=plots/mt_postfit ZZNorm=norm_postfit/ZZ_mmmt.txt FakeNorm=norm_postfit/Fake_mmmt.txt Data=shapes/Data.root_mt_SR.txt
#Plot_postfit Signal=datacards/mmtt_signal_tt.root Ch=ch5 Mlfit=mlfit.root Plot=plots/tt_postfit ZZNorm=norm_postfit/ZZ_mmtt.txt FakeNorm=norm_postfit/Fake_mmtt.txt Data=shapes/Data.root_tt_SR.txt

#Make combined postfit plot
#CombinedPlot_postfit Signal1=datacards/mmtt_signal_ee.root Plot=plots/cmb_postfit ZZNorm1=norm_postfit/ZZ_mmee.txt FakeNorm1=norm_postfit/Fake_mmee.txt Signal2=datacards/mmtt_signal_em.root ZZNorm2=norm_postfit/ZZ_mmme.txt FakeNorm2=norm_postfit/Fake_mmme.txt Signal3=datacards/mmtt_signal_et.root ZZNorm3=norm_postfit/ZZ_mmet.txt FakeNorm3=norm_postfit/Fake_mmet.txt Signal4=datacards/mmtt_signal_mt.root ZZNorm4=norm_postfit/ZZ_mmmt.txt FakeNorm4=norm_postfit/Fake_mmmt.txt Signal5=datacards/mmtt_signal_tt.root ZZNorm5=norm_postfit/ZZ_mmtt.txt FakeNorm5=norm_postfit/Fake_mmtt.txt Data=shapes/Data_cmb.txt Mlfit=mlfit.root
